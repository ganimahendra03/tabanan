<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGIS Kantor Pertanahan Kabupaten Tabanan</title>
    
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.11.0/proj4.js"></script>

    <style>
        :root { --navy: #001f3f; --accent: #0074D9; --lsd-orange: rgba(255, 85, 0, 1.0); }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        /* SEARCH & UI */
        .search-wrapper { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 100; width: 90%; max-width: 420px; display: flex; flex-direction: column; gap: 8px; }
        .mode-container { display: flex; justify-content: center; gap: 8px; }
        .mode-pill { background: rgba(255, 255, 255, 0.95); border: 1px solid #ddd; padding: 5px 15px; border-radius: 20px; font-size: 11px; font-weight: 800; color: #555; cursor: pointer; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .mode-pill.active { background: var(--navy); color: white; border-color: var(--navy); }
        
        .google-bar-container { position: relative; width: 100%; }
        .google-bar { display: flex; align-items: center; background: white; padding: 5px 15px; border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid #eee; position: relative; z-index: 101; }
        .google-bar input { flex: 1; border: none; outline: none; padding: 8px; font-size: 14px; background: transparent; }
        .search-btn { background: none; border: none; cursor: pointer; display: flex; align-items: center; }
        .search-btn svg { fill: var(--navy); width: 22px; height: 22px; }

        .suggest-box { position: absolute; top: 25px; left: 0; width: 100%; background: white; border-radius: 0 0 15px 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); display: none; overflow: hidden; z-index: 100; padding-top: 25px; border: 1px solid #eee; border-top: none; }
        .suggest-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #f9f9f9; display: flex; flex-direction: column; }
        .suggest-item:hover { background: #f0f7ff; }
        .suggest-item .main-name { font-size: 13px; font-weight: 700; color: #333; }
        .suggest-item .sub-name { font-size: 10px; color: #888; }

        /* LEGEND PANEL */
        .legend-toggle { position: absolute; top: 15px; right: 15px; z-index: 110; background: white; width: 34px; height: 34px; border-radius: 4px; border: none; box-shadow: 0 0 0 2px rgba(0,0,0,.1); display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .legend-panel { position: absolute; top: 0; right: -320px; width: 300px; height: 100%; background: #f8f9fa; z-index: 2000; box-shadow: -2px 0 15px rgba(0,0,0,0.2); transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .legend-panel.active { right: 0; }
        .legend-header { background: var(--navy); color: white; padding: 15px; font-size: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .layer-manager-item { background: white; margin: 8px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        .layer-header-row { padding: 8px 12px; display: flex; align-items: center; gap: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
        .layer-title { flex: 1; font-size: 12px; font-weight: bold; color: #333; }
        .eye-icon { cursor: pointer; display: flex; align-items: center; color: var(--navy); }
        .eye-icon.off { color: #ccc !important; }
        .dropdown-content { display: none; padding: 12px; background: #fff; }
        .dropdown-content.active { display: block; }
        .legend-item { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; font-size: 10.5px; }
        .legend-color { width: 14px; height: 14px; border-radius: 3px; border: 1px solid rgba(0,0,0,0.1); }

        /* OPACITY SLIDER */
        .opacity-container { margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
        .opacity-label { font-size: 10px; font-weight: bold; color: #666; margin-bottom: 4px; display: block; }
        .opacity-slider { width: 100%; cursor: pointer; accent-color: var(--navy); height: 4px; }

        /* COORDINATES */
        .coord-container { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); padding: 8px 20px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); z-index: 20; display: flex; align-items: center; gap: 15px; border: 1px solid rgba(255,255,255,0.3); }
        .crs-picker { background: var(--navy); color: white; border: none; padding: 4px 8px; border-radius: 5px; font-size: 10px; font-weight: 600; cursor: pointer; }

        /* BASEMAP */
        .basemap-switcher { position: absolute; bottom: 30px; right: 20px; display: flex; gap: 10px; z-index: 10; }
        .bm-item { width: 60px; height: 60px; border-radius: 10px; cursor: pointer; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); position: relative; overflow: hidden; transition: 0.3s; }
        .bm-item.active { border-color: var(--navy); transform: translateY(-3px); }
        .bm-item img { width: 100%; height: 100%; object-fit: cover; }
        .bm-label { position: absolute; bottom: 0; width: 100%; background: rgba(0,31,63,0.8); color: white; font-size: 7px; text-align: center; padding: 3px 0; font-weight: bold; }

        /* POPUP STYLE */
        .maplibregl-popup-content { padding: 0; border-radius: 12px; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.2); border: none; max-width: 280px !important; }
        .pop-container { max-height: 350px; overflow-y: auto; background: #fff; }
        .pop-section { border-bottom: 1px solid #eee; }
        .pop-header-title { background: #f4f7f9; color: var(--navy); padding: 8px 12px; font-size: 11px; font-weight: 800; text-transform: uppercase; border-bottom: 1px solid #eee; }
        .pop-info-box { padding: 12px; display: flex; align-items: flex-start; gap: 10px; }
        .pop-swatch { width: 18px; height: 18px; border-radius: 4px; flex-shrink: 0; margin-top: 2px; border: 1px solid rgba(0,0,0,0.1); }
        .pop-details { display: flex; flex-direction: column; flex-grow: 1; }
        .pop-obj-name { font-size: 13px; font-weight: 700; color: #222; line-height: 1.3; }
        .pop-sub { font-size: 10px; color: #666; margin-top: 2px; font-weight: 500; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="search-wrapper">
    <div class="mode-container">
        <div id="mode-addr" class="mode-pill active" onclick="setSearchMode('address')">ALAMAT</div>
        <div id="mode-coord" class="mode-pill" onclick="setSearchMode('coordinate')">KOORDINAT</div>
    </div>
    <div class="google-bar-container">
        <div class="google-bar">
            <input type="text" id="search-input" placeholder="Cari alamat atau tempat..." autocomplete="off">
            <button class="search-btn" onclick="handleSearch()">
                <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            </button>
        </div>
        <div id="suggest-box" class="suggest-box"></div>
    </div>
</div>

<div class="legend-toggle" onclick="toggleLegendPanel()"><svg viewBox="0 0 24 24" width="20" height="20"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg></div>

<div class="legend-panel" id="side-legend">
    <div class="legend-header"><span>Legenda</span><span style="cursor:pointer" onclick="toggleLegendPanel()">√ó</span></div>
    <div class="legend-content-wrapper" style="overflow-y: auto;">
        
        <div class="layer-manager-item">
            <div class="layer-header-row" onclick="toggleDropdown('znt-content')">
                <div class="eye-icon off" id="eye-znt" onclick="toggleLyrVis(event, 'znt-fill', 'eye-znt')">üëÅ</div>
                <div class="layer-title">Zona Nilai Tanah 2025</div>
                <div style="font-size: 9px;">‚ñº</div>
            </div>
            <div class="dropdown-content" id="znt-content">
                <div class="opacity-container">
                    <span class="opacity-label">Transparansi</span>
                    <input type="range" class="opacity-slider" min="0" max="100" value="70" oninput="updateOpacity('znt-fill', this.value)">
                </div>
                <div id="znt-legend-list"></div>
            </div>
        </div>

        <div class="layer-manager-item">
            <div class="layer-header-row" onclick="toggleDropdown('lsd-content')">
                <div class="eye-icon" id="eye-lsd" onclick="toggleLyrVis(event, 'lsd-fill', 'eye-lsd')">üëÅ</div>
                <div class="layer-title">LSD Kab. Tabanan</div>
                <div style="font-size: 9px;">‚ñº</div>
            </div>
            <div class="dropdown-content active" id="lsd-content">
                <div class="opacity-container">
                    <span class="opacity-label">Transparansi</span>
                    <input type="range" class="opacity-slider" min="0" max="100" value="70" oninput="updateOpacity('lsd-fill', this.value)">
                </div>
                <div id="lsd-legend-list"></div>
            </div>
        </div>

        <div class="layer-manager-item">
            <div class="layer-header-row" onclick="toggleDropdown('lbs-content')">
                <div class="eye-icon" id="eye-lbs" onclick="toggleLyrVis(event, 'lbs-fill', 'eye-lbs')">üëÅ</div>
                <div class="layer-title">LBS Kab. Tabanan</div>
                <div style="font-size: 9px;">‚ñº</div>
            </div>
            <div class="dropdown-content" id="lbs-content"><div id="lbs-legend-list"></div></div>
        </div>

        <div class="layer-manager-item">
            <div class="layer-header-row" onclick="toggleDropdown('rdtr-content')">
                <div class="eye-icon" id="eye-rdtr" onclick="toggleLyrVis(event, 'rdtr-fill', 'eye-rdtr')">üëÅ</div>
                <div class="layer-title">RDTR Perkotaan Tabanan</div>
                <div style="font-size: 9px;">‚ñº</div>
            </div>
            <div class="dropdown-content" id="rdtr-content"><div id="rdtr-legend-list"></div></div>
        </div>

        <div class="layer-manager-item">
            <div class="layer-header-row" onclick="toggleDropdown('selbar-content')">
                <div class="eye-icon" id="eye-selbar" onclick="toggleLyrVis(event, 'rdtr-selbar-fill', 'eye-selbar')">üëÅ</div>
                <div class="layer-title">RDTR Kecamatan Selemadeg Barat</div>
                <div style="font-size: 9px;">‚ñº</div>
            </div>
            <div class="dropdown-content" id="selbar-content"><div id="selbar-legend-list"></div></div>
        </div>

        <div class="layer-manager-item">
            <div class="layer-header-row" onclick="toggleDropdown('rtrw-content')">
                <div class="eye-icon" id="eye-rtrw" onclick="toggleLyrVis(event, 'rtrw-fill', 'eye-rtrw')">üëÅ</div>
                <div class="layer-title">RTRW Kabupaten Tabanan</div>
                <div style="font-size: 9px;">‚ñº</div>
            </div>
            <div class="dropdown-content" id="rtrw-content"><div id="rtrw-legend-list"></div></div>
        </div>

    </div>
</div>

<div class="coord-container">
    <select id="crs-select" class="crs-picker" onchange="updateCoordLabels()">
        <option value="wgs">WGS 84</option>
        <option value="utm">UTM 50S</option>
        <option value="tm3">TM-3 50.1</option>
    </select>
    <div class="display-data">
        <div style="display:inline-block; margin-right:10px;"><span id="lbl-x" style="font-size:9px; color:#666; display:block;">Bujur (Lon)</span><span id="val-x" style="font-size:11px; font-weight:bold;">0.00000</span></div>
        <div style="display:inline-block;"><span id="lbl-y" style="font-size:9px; color:#666; display:block;">Lintang (Lat)</span><span id="val-y" style="font-size:11px; font-weight:bold;">0.00000</span></div>
    </div>
</div>

<div class="basemap-switcher">
    <div class="bm-item active" id="btn-osm" onclick="changeBasemap('osm')"><img src="thumb-osm.jpg"><div class="bm-label">OSM</div></div>
    <div class="bm-item" id="btn-esri" onclick="changeBasemap('esri')"><img src="thumb-citra.jpg"><div class="bm-label">SATELIT</div></div>
</div>

<script>
    const projUTM = "+proj=utm +zone=50 +south +datum=WGS84 +units=m +no_defs";
    const projTM3 = "+proj=tmerc +lat_0=0 +lon_0=115.5 +k=0.9999 +x_0=200000 +y_0=1500000 +ellps=WGS84 +units=m +no_defs";
    
    const lbsFillColor = 'rgba(230,255,75,1.0)';
    const lbsStrokeColor = 'rgba(170,255,110,1.0)';

    // --- SIMBOLOGI ZNT ---
    const zntSimbo = {
        '< Rp. 100.000': 'rgba(56,168,80,1.0)',
        'Rp. 100.001 - Rp. 200.000': 'rgba(102,191,80,1.0)',
        'Rp. 200.001 - Rp. 400.000': 'rgba(155,217,80,1.0)',
        'Rp. 400.001 - Rp. 800.000': 'rgba(222,242,80,1.0)',
        'Rp. 800.001 - Rp. 1.000.000': 'rgba(225,221,80,1.0)',
        'Rp. 1.000.001 - Rp. 2.000.000': 'rgba(255,145,80,1.0)',
        'Rp. 2.000.001 - Rp. 4.000.000': 'rgba(255,72,80,1.0)',
        '> Rp. 4.000.000': 'rgba(255,0,80,1.0)'
    };

    const rtrwSimbo = {'Badan Air':'rgba(151,219,242,1.0)','Cagar Alam':'rgba(70,70,165,1.0)','Kawasan Hortikultura':'rgba(230,255,75,1.0)','Kawasan Hutan Lindung':'rgba(50,95,40,1.0)','Kawasan Pariwisata':'rgba(255,165,255,1.0)','Kawasan Perkebunan':'rgba(175,175,55,1.0)','Kawasan Perkebunan Rakyat':'rgba(155,220,155,1.0)','Kawasan Perlindungan Setempat':'rgba(5,215,215,1.0)','Kawasan Permukiman Perdesaan':'rgba(235,155,60,1.0)','Kawasan Permukiman Perkotaan':'rgba(245,155,30,1.0)','Kawasan Pertahanan dan Keamanan':'rgba(155,0,255,1.0)','Kawasan Peruntukan Industri':'rgba(105,0,0,1.0)','Kawasan Tanaman Pangan':'rgba(200,245,70,1.0)','Taman Wisata Alam':'rgba(210,190,255,1.0)'};
    const rdtrSimbo = {'Badan Air':'rgba(151,219,242,1.0)','Badan Jalan':'rgba(235,30,30,1.0)','Instalasi Pengolahan Air Minum (IPAM)':'rgba(255,200,105,1.0)','Jalur Hijau':'rgba(15,245,0,1.0)','Kawasan Peruntukan Industri':'rgba(105,0,0,1.0)','Pemakaman':'rgba(90,255,0,1.0)','Perdagangan dan Jasa Skala Kota':'rgba(255,100,100,1.0)','Perdagangan dan Jasa Skala SWP':'rgba(255,165,165,1.0)','Perdagangan dan Jasa Skala WP':'rgba(255,130,130,1.0)','Pergudangan':'rgba(55,55,55,1.0)','Perkantoran':'rgba(155,155,155,1.0)','Perkebunan':'rgba(175,175,55,1.0)','Perlindungan Setempat':'rgba(5,215,215,1.0)','Pertahanan dan Keamanan':'rgba(155,0,255,1.0)','Perumahan Kepadatan Rendah':'rgba(255,250,75,1.0)','Perumahan Kepadatan Sedang':'rgba(255,240,5,1.0)','Perumahan Kepadatan Tinggi':'rgba(255,220,0,1.0)','Rimba Kota':'rgba(55,85,10,1.0)','SPU Skala Kota':'rgba(125,25,125,1.0)','SPU Skala Kecamatan':'rgba(155,50,155,1.0)','SPU Skala Kelurahan':'rgba(185,75,185,1.0)','SPU Skala RW':'rgba(215,100,215,1.0)','Taman Kota':'rgba(65,105,0,1.0)','Taman Kecamatan':'rgba(70,135,0,1.0)','Taman Kelurahan':'rgba(75,165,0,1.0)','Tanaman Pangan':'rgba(200,245,70,1.0)'};
    const selbarSimbo = {'Badan Air': 'rgba(151,219,242,1.0)','Badan Jalan': 'rgba(235,30,30,1.0)','Hutan Lindung': 'rgba(50,95,40,1.0)','Kawasan Peruntukan Industri': 'rgba(105,0,0,1.0)','Pariwisata': 'rgba(255,165,255,1.0)','Pemakaman': 'rgba(90,255,0,1.0)','Perdagangan dan Jasa Skala SWP': 'rgba(255,165,165,1.0)','Perdagangan dan Jasa Skala WP': 'rgba(255,130,130,1.0)','Perkantoran': 'rgba(155,155,155,1.0)','Perkebunan': 'rgba(175,175,55,1.0)','Perkebunan Rakyat': 'rgba(155,220,155,1.0)','Perlindungan Setempat': 'rgba(5,215,215,1.0)','Perumahan Kepadatan Rendah': 'rgba(255,250,75,1.0)','Perumahan Kepadatan Sedang': 'rgba(255,240,5,1.0)','Peternakan': 'rgba(185,235,185,1.0)','SPU Skala Kecamatan': 'rgba(155,50,155,1.0)','SPU Skala Kelurahan': 'rgba(185,75,185,1.0)','Taman Kelurahan': 'rgba(75,165,0,1.0)','Taman RW': 'rgba(80,195,0,1.0)','Tanaman Pangan': 'rgba(200,245,70,1.0)'};

    const map = new maplibregl.Map({
        container: 'map',
        style: { "version": 8, "sources": { "osm": { "type": "raster", "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"], "tileSize": 256 }, "esri": { "type": "raster", "tiles": ["https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"], "tileSize": 256 } }, "layers": [{ "id": "esri-layer", "type": "raster", "source": "esri", "layout": { "visibility": "none" } },{ "id": "osm-layer", "type": "raster", "source": "osm", "layout": { "visibility": "visible" } }] },
        center: [115.1277, -8.4543], zoom: 10
    });

    const searchInput = document.getElementById('search-input');
    const suggestBox = document.getElementById('suggest-box');
    let searchMode = 'address'; 

    map.on('load', () => {
        map.addControl(new maplibregl.NavigationControl(), 'top-left');
        map.addControl(new maplibregl.FullscreenControl(), 'top-left');
        map.addControl(new maplibregl.GeolocateControl({ positionOptions: { enableHighAccuracy: true }, trackUserLocation: true, showUserHeading: true }), 'top-left');

        // --- LOAD SOURCES ---
        map.addSource('znt-src', { 'type': 'geojson', 'data': 'znt_tabanan_2025.geojson' });
        map.addSource('lbs-src', { 'type': 'geojson', 'data': 'lbs_tabanan.geojson' });
        map.addSource('rtrw-src', { 'type': 'geojson', 'data': 'RTRW_Tabanan_3.geojson' });
        map.addSource('rdtr-src', { 'type': 'geojson', 'data': 'rdtr_perkot_tabanan.geojson' });
        map.addSource('selbar-src', { 'type': 'geojson', 'data': 'rdtr_kec_selemadeg_barat.geojson' });
        map.addSource('lsd-src', { 'type': 'geojson', 'data': 'lsd_kabtabanan.geojson' });

        const addFill = (id, src, sim, def, op) => {
            const match = ['match', ['get', 'NAMOBJ']];
            for (const [k, v] of Object.entries(sim)) match.push(k, v);
            match.push(def);
            map.addLayer({ 'id': id, 'type': 'fill', 'source': src, 'paint': { 'fill-color': match, 'fill-opacity': op } });
        };

        // --- ADD LAYERS ---
        // ZNT diletakkan paling bawah tapi posisi MATI (visibility: none)
        map.addLayer({
            'id': 'znt-fill',
            'type': 'fill',
            'source': 'znt-src',
            'layout': { 'visibility': 'none' }, // MATI SAAT BUKA WEB
            'paint': {
                'fill-color': [
                    'step', ['get', 'MEAN'],
                    'rgba(56,168,80,1.0)', 100000.000001, 
                    'rgba(102,191,80,1.0)', 200000.000001,
                    'rgba(155,217,80,1.0)', 400000.000001,
                    'rgba(222,242,80,1.0)', 800000.000001,
                    'rgba(225,221,80,1.0)', 1000000.000001,
                    'rgba(255,145,80,1.0)', 2000000.000001,
                    'rgba(255,72,80,1.0)', 4000000.000001,
                    'rgba(255,0,80,1.0)'
                ],
                'fill-opacity': 0.7,
                'fill-outline-color': 'rgba(156,156,156,1.0)'
            }
        });

        map.addLayer({ 'id': 'lbs-fill', 'type': 'fill', 'source': 'lbs-src', 'paint': { 'fill-color': lbsFillColor, 'fill-opacity': 0.8, 'fill-outline-color': lbsStrokeColor } });
        addFill('rtrw-fill', 'rtrw-src', rtrwSimbo, 'rgba(200,200,200,0.5)', 0.8);
        addFill('rdtr-fill', 'rdtr-src', rdtrSimbo, 'rgba(192,250,246,1.0)', 0.8);
        addFill('rdtr-selbar-fill', 'selbar-src', selbarSimbo, 'rgba(217,245,208,1.0)', 0.8);
        map.addLayer({ 'id': 'lsd-fill', 'type': 'fill', 'source': 'lsd-src', 'paint': { 'fill-color': 'rgba(255, 85, 0, 1.0)', 'fill-opacity': 0.7, 'fill-outline-color': '#ffffff' } });

        // --- RENDER LEGENDS ---
        renderLgd('znt-legend-list', zntSimbo); // Pastikan ada <div id="znt-legend-list"> di HTML
        renderLgd('lbs-legend-list', {'Lahan Baku Sawah (LBS)': lbsFillColor});
        renderLgd('lsd-legend-list', {'Lahan Sawah Dilindungi': 'rgba(255, 85, 0, 1.0)'});
        renderLgd('rtrw-legend-list', rtrwSimbo);
        renderLgd('rdtr-legend-list', rdtrSimbo);
        renderLgd('selbar-legend-list', selbarSimbo);
    });

    // --- LOGIC SUPER POPUP ---
    async function triggerPopup(lngLat) {
        const { lng, lat } = lngLat;
        const utm = proj4('WGS84', projUTM, [lng, lat]);
        const tm3 = proj4('WGS84', projTM3, [lng, lat]);

        let alamat = "Mencari alamat...";
        try {
            const resp = await fetch(`https://photon.komoot.io/reverse?lon=${lng}&lat=${lat}`);
            const data = await resp.json();
            if (data.features && data.features.length > 0) {
                const p = data.features[0].properties;
                alamat = [p.name, p.street, p.district, p.city].filter(Boolean).join(", ") || "Lokasi tanpa nama";
            } else { alamat = "Alamat tidak ditemukan"; }
        } catch (err) { alamat = "Gagal memuat alamat"; }

        const point = map.project(lngLat);
        // Tambahkan znt-fill ke array layers
        const layers = ['lsd-fill', 'lbs-fill', 'rdtr-fill', 'rdtr-selbar-fill', 'rtrw-fill', 'znt-fill'];
        const features = map.queryRenderedFeatures(point, { layers: layers.filter(l => map.getLayer(l)) });

        let popupHtml = `<div class="pop-container">`;

        // SEKSI INFO LOKASI (Koordinat)
        popupHtml += `
            <div class="pop-section">
                <div class="pop-header-title"><span>üìç INFORMASI LOKASI</span></div>
                <div class="pop-info-box">
                    <div class="pop-details">
                        <span class="pop-obj-name" style="font-size:12px; margin-bottom:5px;">${alamat}</span>
                        <div style="font-size: 10px; color: #444; background: #f4f4f4; padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                            <table style="width:100%; border-collapse:collapse;">
                                <tr><td><b>WGS84</b></td><td>: ${lat.toFixed(6)}, ${lng.toFixed(6)}</td></tr>
                                <tr><td><b>UTM 50S</b></td><td>: ${utm[0].toFixed(2)}, ${utm[1].toFixed(2)}</td></tr>
                                <tr><td><b>TM-3</b></td><td>: ${tm3[0].toFixed(2)}, ${tm3[1].toFixed(2)}</td></tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>`;

        if (features.length > 0) {
            features.forEach(f => {
                const props = f.properties;
                const lid = f.layer.id;
                let layerTitle = "Informasi", color = "gray", mainInfo = props.NAMOBJ || "Tidak Ada Data";

                // LOGIKA TIAP LAYER
                if(lid === 'znt-fill') {
                    layerTitle = "Zona Nilai Tanah (ZNT) 2025";
                    const v = props.MEAN;
                    
                    // Menentukan Label dan Warna berdasarkan nilai MEAN
                    if (v <= 100000) { 
                        mainInfo = "< Rp. 100.000"; 
                        color = 'rgba(56,168,80,1.0)'; 
                    } else if (v <= 200000) { 
                        mainInfo = "Rp. 100.001 - Rp. 200.000"; 
                        color = 'rgba(102,191,80,1.0)'; 
                    } else if (v <= 400000) { 
                        mainInfo = "Rp. 200.001 - Rp. 400.000"; 
                        color = 'rgba(155,217,80,1.0)'; 
                    } else if (v <= 800000) { 
                        mainInfo = "Rp. 400.001 - Rp. 800.000"; 
                        color = 'rgba(222,242,80,1.0)'; 
                    } else if (v <= 1000000) { 
                        mainInfo = "Rp. 800.001 - Rp. 1.000.000"; 
                        color = 'rgba(225,221,80,1.0)'; 
                    } else if (v <= 2000000) { 
                        mainInfo = "Rp. 1.000.001 - Rp. 2.000.000"; 
                        color = 'rgba(255,145,80,1.0)'; 
                    } else if (v <= 4000000) { 
                        mainInfo = "Rp. 2.000.001 - Rp. 4.000.000"; 
                        color = 'rgba(255,72,80,1.0)'; 
                    } else { 
                        mainInfo = "> Rp. 4.000.000"; 
                        color = 'rgba(255,0,80,1.0)'; 
                    }
                }
                else if(lid === 'lbs-fill') { layerTitle = "Informasi Lahan Baku Sawah"; color = lbsFillColor; mainInfo = "Berada Pada Lahan Baku Sawah"; }
                else if(lid === 'lsd-fill') { layerTitle = "Informasi Lahan Sawah Dilindungi"; color = 'rgba(255, 85, 0, 1.0)'; mainInfo = props.LSD ? "Berada Pada Lahan Sawah Dilindungi" : "Tidak Berada pada LSD"; } 
                else if(lid === 'rtrw-fill') { layerTitle = "Informasi RTRW Kabupaten Tabanan"; color = rtrwSimbo[mainInfo] || '#ccc'; } 
                else if(lid === 'rdtr-fill') { layerTitle = "Informasi RDTR Perkotaan Tabanan"; color = rdtrSimbo[mainInfo] || '#ccc'; } 
                else if(lid === 'rdtr-selbar-fill') { layerTitle = "Informasi RDTR Kecamatan Selemadeg Barat"; color = selbarSimbo[mainInfo] || '#ccc'; }

                popupHtml += `<div class="pop-section">
                    <div class="pop-header-title"><span>${layerTitle}</span></div>
                    <div class="pop-info-box">
                        <div class="pop-swatch" style="background:${color}"></div>
                        <div class="pop-details">
                            <span class="pop-obj-name">${mainInfo}</span>
                            ${props.KECAMATAN ? `<span class="pop-sub">Kec. ${props.KECAMATAN}</span>` : ''}
                        </div>
                    </div>
                </div>`;

                if(lid === 'rtrw-fill') {
                    let valRaw = props.KP2B_2 ? props.KP2B_2.toString().trim() : "";
                    let teksTampilan = (valRaw === "K02A" || valRaw === "Ada") ? "Berada Pada Kawasan Pertanian Pangan Berkelanjutan" : "Tidak Berada Pada Kawasan Pertanian Pangan Berkelanjutan";
                    popupHtml += `<div class="pop-section"><div class="pop-header-title"><span>INFORMASI KP2B</span></div><div class="pop-info-box"><div class="pop-details"><span class="pop-obj-name">${teksTampilan}</span></div></div></div>`;
                }
            });
        } else {
            popupHtml += `<div class="pop-section" style="padding:10px; text-align:center; color:gray; font-style:italic; font-size:11px;">Klik area poligon untuk melihat data tata ruang.</div>`;
        }

        popupHtml += `</div>`;
        new maplibregl.Popup({ offset: [0, -10], maxWidth: '300px' }).setLngLat(lngLat).setHTML(popupHtml).addTo(map);
    }

    // --- SEARCH & SUGGESTION ---
    searchInput.addEventListener('input', function() {
        const val = this.value;
        if (searchMode !== 'address' || val.length < 3) { suggestBox.style.display = 'none'; return; }
        fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(val)}&bbox=114.4,-8.8,115.5,-8.1&limit=5`)
            .then(r => r.json()).then(data => {
                suggestBox.innerHTML = '';
                if(data.features && data.features.length > 0) {
                    suggestBox.style.display = 'block';
                    data.features.forEach(f => {
                        const item = f.properties;
                        const [lon, lat] = f.geometry.coordinates;
                        const div = document.createElement('div');
                        div.className = 'suggest-item';
                        div.innerHTML = `<span class="main-name">${item.name || ''}</span><span class="sub-name" style="display:block; font-size:0.8em; color:gray;">${item.city || item.district || ''}</span>`;
                        div.onclick = () => {
                            searchInput.value = item.name || '';
                            suggestBox.style.display = 'none'; 
                            gotoLocation(lon, lat);
                        };
                        suggestBox.appendChild(div);
                    });
                } else { suggestBox.style.display = 'none'; }
            });
    });

    function handleSearch() {
        const val = searchInput.value;
        if (!val) return;
        suggestBox.style.display = 'none';

        if (searchMode === 'address') {
            fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(val)}&bbox=114.4,-8.8,115.5,-8.1&limit=1`)
                .then(r => r.json()).then(d => {
                    if (d.features && d.features.length > 0) {
                        const [lon, lat] = d.features[0].geometry.coordinates;
                        gotoLocation(lon, lat);
                    }
                });
        } else {
            const parts = val.split(/[ ,]+/).map(Number);
            if (parts.length === 2) {
                const c = document.getElementById('crs-select').value;
                let flon, flat;
                if (c === 'utm') { [flon, flat] = proj4(projUTM, 'WGS84', [parts[0], parts[1]]); }
                else if (c === 'tm3') { [flon, flat] = proj4(projTM3, 'WGS84', [parts[0], parts[1]]); }
                else { if (parts[0] < 0) { flat = parts[0]; flon = parts[1]; } else { flon = parts[0]; flat = parts[1]; } }
                gotoLocation(flon, flat);
            }
        }
    }

    function gotoLocation(lon, lat) {
        if (isNaN(lon) || isNaN(lat)) return;
        suggestBox.style.display = 'none'; 
        map.flyTo({ center: [lon, lat], zoom: 17, essential: true });
        map.once('moveend', () => { triggerPopup({ lng: lon, lat: lat }); });
    }

    function setSearchMode(m) { 
        searchMode = m; 
        document.getElementById('mode-addr').className = m === 'address' ? 'mode-pill active' : 'mode-pill';
        document.getElementById('mode-coord').className = m === 'coordinate' ? 'mode-pill active' : 'mode-pill';
        updatePlaceholder();
        suggestBox.style.display = 'none';
        searchInput.value = '';
    }

    function updateCoordLabels() { 
        const c = document.getElementById('crs-select').value; 
        document.getElementById('lbl-x').innerText = c === 'wgs' ? "Bujur (Lon)" : "Timur (X)"; 
        document.getElementById('lbl-y').innerText = c === 'wgs' ? "Lintang (Lat)" : "Utara (Y)"; 
        if (searchMode === 'coordinate') updatePlaceholder();
    }

    function updatePlaceholder() {
        const c = document.getElementById('crs-select').value;
        if (searchMode === 'address') { searchInput.placeholder = "Cari alamat atau tempat..."; }
        else {
            if (c === 'wgs') searchInput.placeholder = "Contoh: -8.45, 115.12";
            else if (c === 'utm') searchInput.placeholder = "UTM: X, Y (301234, 9062345)";
            else if (c === 'tm3') searchInput.placeholder = "TM-3: X, Y (204500, 1465000)";
        }
    }

    map.on('click', (e) => { triggerPopup(e.lngLat); });

    function updateOpacity(lyr, val) { const opacity = parseFloat(val) / 100; if (map.getLayer(lyr)) map.setPaintProperty(lyr, 'fill-opacity', opacity); }
    function toggleLyrVis(e, lyr, ico) { e.stopPropagation(); const v = map.getLayoutProperty(lyr, 'visibility') !== 'none'; map.setLayoutProperty(lyr, 'visibility', v ? 'none' : 'visible'); document.getElementById(ico).classList.toggle('off', v); }
    function toggleDropdown(id) { document.getElementById(id).classList.toggle('active'); }
    function toggleLegendPanel() { document.getElementById('side-legend').classList.toggle('active'); }
    function renderLgd(id, sim) { const c = document.getElementById(id); if(!c) return; Object.entries(sim).forEach(([n, col]) => { c.innerHTML += `<div class="legend-item"><div class="legend-color" style="background:${col}"></div><span>${n}</span></div>`; }); }
    function changeBasemap(t) { map.setLayoutProperty('osm-layer', 'visibility', t==='osm'?'visible':'none'); map.setLayoutProperty('esri-layer', 'visibility', t==='esri'?'visible':'none'); document.getElementById('btn-osm').className = t==='osm'?'bm-item active':'bm-item'; document.getElementById('btn-esri').className = t==='esri'?'bm-item active':'bm-item'; }

    map.on('mousemove', (e) => {
        const { lng, lat } = e.lngLat;
        const c = document.getElementById('crs-select').value;
        let x = lng, y = lat;
        if (c === 'utm') [x, y] = proj4('WGS84', projUTM, [lng, lat]);
        if (c === 'tm3') [x, y] = proj4('WGS84', projTM3, [lng, lat]);
        document.getElementById('val-x').innerText = x.toFixed(3);
        document.getElementById('val-y').innerText = y.toFixed(3);
        const activeLayers = ['znt-fill', 'lsd-fill', 'lbs-fill', 'rdtr-fill', 'rdtr-selbar-fill', 'rtrw-fill'];
        const features = map.queryRenderedFeatures(e.point, { layers: activeLayers.filter(l => map.getLayer(l)) });
        map.getCanvas().style.cursor = features.length ? 'pointer' : '';
    });

    // --- TUTUP POPUP DENGAN TOMBOL ESCAPE ---
    document.addEventListener('keydown', (e) => {
        if (e.key === "Escape") {
            const popups = document.getElementsByClassName('maplibregl-popup');
            if (popups.length > 0) {
                for (let i = 0; i < popups.length; i++) {
                    popups[i].remove();
                }
                suggestBox.style.display = 'none';
            }
        }
    });
    
    document.addEventListener('click', (e) => { if (!e.target.closest('.search-wrapper')) suggestBox.style.display = 'none'; });
</script>
</body>
</html>
