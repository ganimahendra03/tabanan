<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGIS Tabanan - Multi Opacity</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; }
        #map { width: 100%; height: 100vh; background-color: #f0f0f0; }

        /* --- SEARCH UI --- */
        .search-wrapper {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .mode-toggle {
            display: flex; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px);
            padding: 3px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.4);
        }
        .mode-btn {
            font-size: 10px; padding: 5px 12px; border: none; background: none;
            cursor: pointer; border-radius: 15px; font-weight: bold; color: #444; transition: 0.3s;
        }
        .mode-btn.active { background: #003366; color: white; }
        .search-container {
            display: flex; background: rgba(255, 255, 255, 0.7); 
            backdrop-filter: blur(5px); padding: 6px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); gap: 5px;
            border: 1px solid rgba(255, 255, 255, 0.3); position: relative;
        }
        .search-container input {
            border: 1px solid rgba(0, 0, 0, 0.1); background: rgba(255, 255, 255, 0.8);
            padding: 6px 10px; border-radius: 5px; outline: none; font-size: 12px; transition: all 0.3s;
        }
        #input-addr { width: 270px; }
        .input-coord { width: 130px; }
        .search-container button {
            background-color: rgba(0, 51, 102, 0.8); color: white; border: none;
            padding: 0 12px; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold;
        }

        /* --- KOTAK KOORDINAT --- */
        .custom-mouse-position { 
            position: absolute; bottom: 30px; left: 30px; z-index: 3000; 
            display: flex; align-items: center; justify-content: center; 
            background-color: #003366; color: #ffffff !important; 
            height: 30px; min-width: 230px; padding: 0 20px; 
            border-radius: 8px; border: 2px solid #0055aa; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.4); 
            font-family: 'Courier New', Courier, monospace; font-size: 13px; font-weight: bold; text-align: center;
        }

        /* --- KONTROL KANAN BAWAH --- */
        .bottom-right-controls { 
            position: absolute; top: 30px; right: 20px; 
            z-index: 2000; display: flex; flex-direction: column; gap: 10px; align-items: flex-end;
        }
        .layer-menu { 
            background: white; padding: 15px; border-radius: 10px; 
            box-shadow: 0 4px 25px rgba(0,0,0,0.2); display: none; min-width: 220px; 
            border: 1px solid #ddd; max-height: 75vh; overflow-y: auto;
            position: absolute; top: 0px; right: 55px;
        }
        .action-btn { 
            width: 40px; height: 40px; background: white; border-radius: 10px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; border: none;
            display: flex; align-items: center; justify-content: center;
        }
        .action-btn img { width: 20px; height: 20px; }

        .dropdown-legend-btn {
            width: 100%; background: #f4f4f4; border: 1px solid #ddd;
            padding: 6px; margin-top: 8px; border-radius: 5px; cursor: pointer;
            font-size: 11px; font-weight: bold; color: #003366;
            display: flex; justify-content: space-between; align-items: center;
        }
        #legendList { display: none; }

        /* --- POPUP --- */
        .ol-popup {
            position: absolute; background-color: white; box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            padding: 15px; border-radius: 10px; border: 1px solid #cccccc; bottom: 12px;
            left: -50px; min-width: 200px;
        }
        .ol-popup-closer {
            text-decoration: none; position: absolute; top: 5px; right: 10px;
            cursor: pointer; font-size: 16px; font-weight: bold; color: #888;
        }
        .ol-popup-closer:after { content: "✖"; }
        .gps-active { background-color: #e3f2fd !important; border: 2px solid #2196f3 !important; }

        /* --- STYLING SLIDER --- */
        .opacity-container {
            background: white; padding: 12px; border-radius: 10px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid #ddd; 
            width: 130px; display: flex; flex-direction: column; gap: 10px;
        }
        .slider-group { display: flex; flex-direction: column; gap: 4px; }
        .slider-label { font-size: 9px; font-weight: bold; color: #555; text-transform: uppercase; }
        input[type="range"] { cursor: pointer; accent-color: #003366; width: 100%; }

        @media (max-width: 600px) {
            #input-addr { width: 160px; }
            .input-coord { width: 75px; }
            .custom-mouse-position { min-width: 180px; bottom: 100px; left: 50%; transform: translateX(-50%); font-size: 11px; }
        }
    </style>
</head>
<body>

    <div class="search-wrapper">
        <div class="mode-toggle">
            <button class="mode-btn active" id="btn-mode-addr" onclick="switchMode('addr')">ALAMAT</button>
            <button class="mode-btn" id="btn-mode-coord" onclick="switchMode('coord')">KOORDINAT</button>
        </div>
        <div class="search-container">
            <div id="box-addr">
                <input type="text" id="input-addr" placeholder="Cari alamat..." autocomplete="off">
            </div>
            <div id="box-coord" style="display: none;">
                <input type="text" id="input-x" class="input-coord" placeholder="X / Lon">
                <input type="text" id="input-y" class="input-coord" placeholder="Y / Lat">
            </div>
            <button onclick="executeSearch()">Cari</button>
        </div>
    </div>

    <div id="mouse-position" class="custom-mouse-position"></div>

    <div class="bottom-right-controls">
        <div id="layer-window" class="layer-menu">
            <p style="margin:0 0 8px; font-size:11px; color:#888; font-weight:bold;">BASEMAP</p>
            <label style="font-size:13px;"><input type="radio" name="base" value="osm" checked onchange="changeBasemap(this.value)"> OpenStreetMap</label><br>
            <label style="font-size:13px;"><input type="radio" name="base" value="arcgis" onchange="changeBasemap(this.value)"> ArcGIS Satelit</label>
            
            <hr style="margin:10px 0; border:0; border-top:1px solid #eee;">
            
            <p style="margin:0 0 8px; font-size:11px; color:#888; font-weight:bold;">DATA LAYER</p>
            <label style="font-weight:bold; cursor:pointer; font-size:13px;">
                <input type="checkbox" id="toggleRTRW" checked> RTRW Kabupaten Tabanan
            </label><br>
            <label style="font-weight:bold; cursor:pointer; font-size:13px; color: #ff5500;">
                <input type="checkbox" id="toggleLSD" checked> LSD (Lahan Sawah Dilindungi)
            </label>

            <button class="dropdown-legend-btn" id="btn-legend" onclick="toggleLegendMenu()">
                <span>TAMPILKAN LEGENDA</span> <span id="leg-arrow">▼</span>
            </button>
            <div id="legendList" style="max-height: 200px; overflow-y: auto; margin-top: 8px; padding-left: 5px; font-size: 10px; border-left: 2px solid #eee;"></div>

            <hr style="margin:10px 0; border:0; border-top:1px solid #eee;">
            
            <p style="margin:0 0 8px; font-size:11px; color:#888; font-weight:bold;">SISTEM KOORDINAT</p>
            <label style="font-size:13px;"><input type="radio" name="coord_sys" value="latlong" checked> Geografis (WGS84)</label><br>
            <label style="font-size:13px;"><input type="radio" name="coord_sys" value="tm3"> TM-3 (Zona 50.1)</label><br>
            <label style="font-size:13px;"><input type="radio" name="coord_sys" value="utm"> UTM (Zona 50S)</label>
        </div>
        
        <button class="action-btn" onclick="toggleLayerMenu()" title="Layer & Legenda">
            <img src="https://img.icons8.com/ios-filled/50/003366/layers.png">
        </button>
        
        <button id="gps-btn" class="action-btn" onclick="getMyLocation()" title="Lokasi Saya">
            <img src="https://img.icons8.com/ios-filled/50/003366/compass.png">
        </button>

        <div class="opacity-container">
            <div class="slider-group">
                <span class="slider-label">Transp. RTRW</span>
                <input type="range" id="opacityRTRW" min="0" max="1" step="0.1" value="1">
            </div>
            <div class="slider-group">
                <span class="slider-label">Transp. LSD</span>
                <input type="range" id="opacityLSD" min="0" max="1" step="0.1" value="1">
            </div>
        </div>
    </div>

    <div id="map"></div>

    <div id="popup" class="ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content"></div>
    </div>

    <script>
        proj4.defs("EPSG:23880","+proj=tmerc +lat_0=0 +lon_0=115.5 +k=0.9999 +x_0=200000 +y_0=1500000 +ellps=WGS84 +units=m +no_defs");
        proj4.defs("EPSG:32750","+proj=utm +zone=50 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs");
        ol.proj.proj4.register(proj4);

        const baseLayers = {
            'osm': new ol.layer.Tile({ source: new ol.source.OSM(), visible: true }),
            'arcgis': new ol.layer.Tile({ source: new ol.source.XYZ({ url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}' }), visible: false })
        };

        const rtrwData = {
            'Badan Air': 'rgba(151,219,242,1.0)',
            'Cagar Alam': 'rgba(70,70,165,1.0)',
            'Kawasan Hortikultura': 'rgba(230,255,75,1.0)',
            'Kawasan Hutan Lindung': 'rgba(50,95,40,1.0)',
            'Kawasan Pariwisata': 'rgba(255,165,255,1.0)',
            'Kawasan Perkebunan': 'rgba(175,175,55,1.0)',
            'Kawasan Perkebunan Rakyat': 'rgba(155,220,155,1.0)',
            'Kawasan Perlindungan Setempat': 'rgba(5,215,215,1.0)',
            'Kawasan Permukiman Perdesaan': 'rgba(235,155,60,1.0)',
            'Kawasan Permukiman Perkotaan': 'rgba(245,155,30,1.0)',
            'Kawasan Pertahanan dan Keamanan': 'rgba(155,0,255,1.0)',
            'Kawasan Peruntukan Industri': 'rgba(105,0,0,1.0)',
            'Kawasan Tanaman Pangan': 'rgba(200,245,70,1.0)',
            'Taman Wisata Alam': 'rgba(210,190,255,1.0)'
        };

        const lsdColor = 'rgba(255, 85, 0, 0.7)'; 
        const lsdStroke = 'rgba(255, 85, 0, 1.0)';

        const tataruangLayer = new ol.layer.Vector({
            source: new ol.source.Vector({
                url: 'https://api.maptiler.com/data/019c0858-a8d2-7d23-8d8c-d0fcb2f62898/features.json?key=rQCoMBjxgrq4YAZGqBKF',
                format: new ol.format.GeoJSON()
            }),
            renderMode: 'image',
            zIndex: 2,
            style: function(feature) {
                const val = feature.get("NAMOBJ");
                const color = rtrwData[val] || 'rgba(200,200,200,0.5)';
                return new ol.style.Style({
                    fill: new ol.style.Fill({ color: color }),
                    stroke: new ol.style.Stroke({ color: 'rgba(110,110,110,0.5)', width: 0.5 })
                });
            }
        });

        const lsdLayer = new ol.layer.Vector({
            source: new ol.source.Vector({
                url: 'LSD_Tabanan.geojson',
                format: new ol.format.GeoJSON()
            }),
            zIndex: 3, // Diletakkan di atas RTRW agar Orennya jelas terlihat saat ditumpuk
            style: new ol.style.Style({
                fill: new ol.style.Fill({ color: lsdColor }),
                stroke: new ol.style.Stroke({ color: lsdStroke, width: 1 })
            })
        });

        const markerSource = new ol.source.Vector();
        const markerLayer = new ol.layer.Vector({
            source: markerSource, zIndex: 100,
            style: new ol.style.Style({ image: new ol.style.Icon({ anchor: [0.5, 1], src: 'https://img.icons8.com/color/48/000000/marker.png', scale: 0.8 }) })
        });

        const mousePositionControl = new ol.control.MousePosition({
            coordinateFormat: (coord) => `Lon: ${coord[0].toFixed(5)} | Lat: ${coord[1].toFixed(5)}`,
            projection: 'EPSG:4326', target: document.getElementById('mouse-position'), undefinedHTML: 'Gerakkan Kursor'
        });

        const map = new ol.Map({
            target: 'map',
            layers: [baseLayers.osm, baseLayers.arcgis, tataruangLayer, lsdLayer, markerLayer],
            view: new ol.View({ center: ol.proj.fromLonLat([115.1251, -8.4554]), zoom: 11 }),
            controls: ol.control.defaults.defaults({ attribution: false }).extend([mousePositionControl])
        });

        const overlay = new ol.Overlay({ element: document.getElementById('popup'), autoPan: true });
        map.addOverlay(overlay);
        document.getElementById('popup-closer').onclick = () => { overlay.setPosition(undefined); return false; };

        map.on('singleclick', function (evt) {
            const feature = map.forEachFeatureAtPixel(evt.pixel, (feat) => feat);
            if (feature) {
                const props = feature.getProperties();
                let content = `<div style="border-bottom: 2px solid #003366; margin-bottom: 8px; padding-bottom: 5px;"><b style="font-size: 14px; color: #003366;">DETAIL INFORMASI</b></div><div style="font-size: 13px;">`;
                if(props.NAMOBJ) content += `<b>RTRW :</b> ${props.NAMOBJ}<br>`;
                if(props.LSD) content += `<b>LSD :</b> <span style="color:#ff5500; font-weight:bold;">${props.LSD}</span><br>`;
                content += `<hr style="border: 0; border-top: 1px solid #eee; margin: 8px 0;"><small style="color: #888;">Kabupaten Tabanan</small></div>`;
                document.getElementById('popup-content').innerHTML = content;
                overlay.setPosition(evt.coordinate);
            } else { overlay.setPosition(undefined); }
        });

        function generateLegend() {
            const listContainer = document.getElementById('legendList');
            listContainer.innerHTML = ""; 
            const headerLsd = document.createElement('div');
            headerLsd.innerHTML = `<p style="margin:5px 0; font-weight:bold; border-bottom:1px solid #ccc; color:#ff5500;">LAYER LSD</p>`;
            listContainer.appendChild(headerLsd);
            const lsdItem = document.createElement('div');
            lsdItem.style.display = 'flex'; lsdItem.style.alignItems = 'center'; lsdItem.style.marginBottom = '8px';
            lsdItem.innerHTML = `<div style="width:14px; height:14px; background:${lsdColor}; margin-right:8px; border:1px solid ${lsdStroke};"></div><span style="font-weight:bold;">Lahan Sawah Dilindungi</span>`;
            listContainer.appendChild(lsdItem);
            const headerRtrw = document.createElement('div');
            headerRtrw.innerHTML = `<p style="margin:10px 0 5px; font-weight:bold; border-bottom:1px solid #ccc; color:#003366;">LAYER RTRW</p>`;
            listContainer.appendChild(headerRtrw);
            for (const [nama, warna] of Object.entries(rtrwData)) {
                const div = document.createElement('div');
                div.style.display = 'flex'; div.style.alignItems = 'center'; div.style.marginBottom = '4px';
                div.innerHTML = `<div style="width:12px; height:12px; background:${warna}; margin-right:8px; border:0.5px solid #000;"></div><span>${nama}</span>`;
                listContainer.appendChild(div);
            }
        }
        generateLegend();

        function toggleLayerMenu() {
            const m = document.getElementById('layer-window');
            m.style.display = (m.style.display === 'block') ? 'none' : 'block';
        }

        function toggleLegendMenu() {
            const list = document.getElementById('legendList');
            const arrow = document.getElementById('leg-arrow');
            const btnText = document.querySelector('#btn-legend span');
            if (list.style.display === "none" || list.style.display === "") {
                list.style.display = "block"; arrow.innerText = "▲"; btnText.innerText = "SEMBUNYIKAN LEGENDA";
            } else {
                list.style.display = "none"; arrow.innerText = "▼"; btnText.innerText = "TAMPILKAN LEGENDA";
            }
        }

        function changeBasemap(val) {
            baseLayers.osm.setVisible(val === 'osm');
            baseLayers.arcgis.setVisible(val === 'arcgis');
        }

        // KONTROL VISIBILITAS & SLIDER
        document.getElementById('toggleRTRW').onchange = (e) => tataruangLayer.setVisible(e.target.checked);
        document.getElementById('toggleLSD').onchange = (e) => lsdLayer.setVisible(e.target.checked);

        document.getElementById('opacityRTRW').oninput = (e) => tataruangLayer.setOpacity(parseFloat(e.target.value));
        document.getElementById('opacityLSD').oninput = (e) => lsdLayer.setOpacity(parseFloat(e.target.value));

        function switchMode(mode) {
            document.getElementById('box-addr').style.display = mode === 'addr' ? 'block' : 'none';
            document.getElementById('box-coord').style.display = mode === 'coord' ? 'block' : 'none';
            document.getElementById('btn-mode-addr').className = mode === 'addr' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('btn-mode-coord').className = mode === 'coord' ? 'mode-btn active' : 'mode-btn';
        }

        function executeSearch() {
            if (document.getElementById('box-addr').style.display !== 'none') {
                const q = document.getElementById('input-addr').value;
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&viewbox=114.4,-8.0,115.8,-8.9&bounded=1`)
                    .then(r => r.json()).then(d => {
                        if (d[0]) {
                            const c = ol.proj.fromLonLat([+d[0].lon, +d[0].lat]);
                            markerSource.clear();
                            markerSource.addFeature(new ol.Feature({ geometry: new ol.geom.Point(c) }));
                            map.getView().animate({ center: c, zoom: 17 });
                        }
                    });
            } else {
                const x = parseFloat(document.getElementById('input-x').value);
                const y = parseFloat(document.getElementById('input-y').value);
                if (!isNaN(x) && !isNaN(y)) {
                    const sys = document.querySelector('input[name="coord_sys"]:checked').value;
                    let c;
                    if (sys === 'utm') c = ol.proj.transform([x, y], 'EPSG:32750', 'EPSG:3857');
                    else if (sys === 'tm3') c = ol.proj.transform([x, y], 'EPSG:23880', 'EPSG:3857');
                    else c = ol.proj.fromLonLat([x, y]);
                    markerSource.clear(); markerSource.addFeature(new ol.Feature({ geometry: new ol.geom.Point(c) }));
                    map.getView().animate({ center: c, zoom: 17 });
                }
            }
        }

        let watchId = null;
        function getMyLocation() {
            const btn = document.getElementById('gps-btn');
            if (!navigator.geolocation) return alert("GPS tidak didukung");
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId); watchId = null; markerSource.clear();
                btn.classList.remove('gps-active'); return;
            }
            btn.classList.add('gps-active');
            watchId = navigator.geolocation.watchPosition((pos) => {
                const olCoords = ol.proj.fromLonLat([pos.coords.longitude, pos.coords.latitude]);
                const gpsFeat = new ol.Feature({ geometry: new ol.geom.Point(olCoords) });
                gpsFeat.setStyle(new ol.style.Style({ image: new ol.style.Circle({ radius: 8, fill: new ol.style.Fill({ color: '#2196F3' }), stroke: new ol.style.Stroke({ color: 'white', width: 3 }) }) }));
                markerSource.clear(); markerSource.addFeature(gpsFeat);
                map.getView().animate({ center: olCoords, zoom: 17 });
            }, () => {}, { enableHighAccuracy: true });
        }

        document.querySelectorAll('input[name="coord_sys"]').forEach(i => i.onchange = function() {
            const val = this.value;
            if (val === 'utm') {
                mousePositionControl.setProjection('EPSG:32750');
                mousePositionControl.setCoordinateFormat((c) => `UTM X: ${c[0].toFixed(2)} | Y: ${c[1].toFixed(2)}`);
            } else if (val === 'tm3') {
                mousePositionControl.setProjection('EPSG:23880');
                mousePositionControl.setCoordinateFormat((c) => `TM3 X: ${c[0].toFixed(3)} | Y: ${c[1].toFixed(3)}`);
            } else {
                mousePositionControl.setProjection('EPSG:4326');
                mousePositionControl.setCoordinateFormat((c) => `Lon: ${c[0].toFixed(5)} | Lat: ${c[1].toFixed(5)}`);
            }
        });
    </script>
</body>
</html>
